<!-- This layout is used in all pages. Making changes here will efect all pages. We recommend not to change anything here. --> <!DOCTYPE html><html lang="en"><head><meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" /><link rel="dns-prefetch" href="//fonts.googleapis.com" /><link rel="dns-prefetch" href="//google-analytics.com" /><link rel="dns-prefetch" href="//www.google-analytics.com" /><link rel="dns-prefetch" href="//maxcdn.bootstrapcdn.com" /><link rel="dns-prefetch" href="//ajax.googleapis.com" /><link rel="dns-prefetch" href="//fonts.gstatic.com" /><link rel="dns-prefetch" href="https://.disqus.com/" /><title>VMWare Pro Homelab Active Directory Forest Setup pt. 2 | My Portfolio</title><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="VMWare Pro Homelab Active Directory Forest Setup pt. 2" /><meta name="author" content="Ethan Epperson" /><meta property="og:locale" content="en_US" /><meta name="description" content="Creating New User Account Objects" /><meta property="og:description" content="Creating New User Account Objects" /><link rel="canonical" href="http://localhost:4000/blog/homelab-ad-forest-pt.2/" /><meta property="og:url" content="http://localhost:4000/blog/homelab-ad-forest-pt.2/" /><meta property="og:site_name" content="My Portfolio" /><meta property="og:image" content="http://localhost:4000/assets/images/thumbnails/homelab/Homelab-setup-guide-windows.jpg" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-01-14T00:00:00-05:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="http://localhost:4000/assets/images/thumbnails/homelab/Homelab-setup-guide-windows.jpg" /><meta property="twitter:title" content="VMWare Pro Homelab Active Directory Forest Setup pt. 2" /><script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Ethan Epperson"},"dateModified":"2024-01-14T00:00:00-05:00","datePublished":"2024-01-14T00:00:00-05:00","description":"Creating New User Account Objects","headline":"VMWare Pro Homelab Active Directory Forest Setup pt. 2","image":"http://localhost:4000/assets/images/thumbnails/homelab/Homelab-setup-guide-windows.jpg","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/blog/homelab-ad-forest-pt.2/"},"url":"http://localhost:4000/blog/homelab-ad-forest-pt.2/"}</script><link rel="stylesheet" href="/assets/css/main-default.css" /><link id="color-scheme" rel="stylesheet" href="/assets/css/main-default.css" /><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/apple-icon-60x60.png" /><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/apple-icon-114x114.png" /><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/apple-icon-152x152.png" /><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/android-icon-192x192.png" /><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" /><link rel="icon" href="/favicon.ico" type="image/x-icon" /><script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML" ></script><script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script></head><body><div class="loader"><div class="lds-ring"><div></div><div></div><div></div><div></div></div></div><div class="wrapper"><div class="container-grid"><div class="sidebar"><div class="author-container shadow"><div class="author"> <a href="/"> <img src="/assets/images/headshots/professional-hs.jpg" width="100%" height="auto;" alt="My Portfolio"loading="lazy" /> </a></div><div class="about text-center"><h1 class="title"><a href="/">Ethan Epperson</a></h1></div><div class="bio text-center"><p class="m0">Cybersecurity Student | Let's Defend Together</p></div><hr class="dashed"><div class="social text-center"> <ul class="portfolio p0"> <li><a href="/projects/">Projects</a></li> <li><a href="/blog/">Blog</a></li> <li><a href="/contact/">Contact</a></li> </ul> <ul class="sm p0 m0a"> <li><a href="https://www.linkedin.com/in/ethan-epperson-8608b5277"><i class="fa fa-linkedin"></i></a></li> <li><a href="https://www.github.com/EEpp14"><i class="fa fa-github"></i></a></li> </ul></div></div></div><div class="main"><div class="main-container shadow"><div class="title-space"> <h1>VMWare Pro Homelab | Active Directory Forest Setup pt. 2</h1><div class="input-group mb-3" data-aos="zoom-in"> <input type="text" class="form-control border-right-0" id="search-input" /><div class="input-group-append"> <span class="input-group-text" ><i class="fa fa-search"></i ></span></div></div></div><hr class="dashed" /> <main> <ul class="breadcrumbs"> <li><a href="/">Home</a></li> <li> <a href="/blog" >Blog</a > </li> <li> <a href="#" >Homelab ad forest...</a > </li> </ul><div class="meta" data-aos="fade-up"> <p> <small> <span> <i class="fa fa-calendar" aria-hidden="true"></i> 14 Jan 2024&nbsp; </span> <span> <i class="fa fa-user" aria-hidden="true"></i> Ethan Epperson&nbsp; </span> <span> <i class="fa fa-clock-o" aria-hidden="true"></i> 8 mins read. </span> </small> </p></div><div class="featured-image rounded shadow" style="background-image: url(/assets/images/thumbnails/homelab/Homelab-setup-guide-windows.jpg)" data-aos="zoom-in" ></div><div class="container"> <article> <ul class="toc"> <li><a href="#creating-new-user-account-objects">Creating New User Account Objects</a></li> <li><a href="#setting-up-service-principal-name-for-sql-service">Setting Up Service Principal Name for SQL Service</a></li> <li><a href="#creating-an-smb-share-to-open-ports">Creating an SMB Share to Open Ports</a></li> <li><a href="#windows-10-enterprise-installation">Windows 10 Enterprise Installation</a></li> <li><a href="#joining-the-clients-to-the-domain">Joining the Clients to the Domain</a></li> <li><a href="#creating-local-administrators-for-the-client-machines">Creating Local Administrators for the Client Machines</a></li> </ul> <h2 id="creating-new-user-account-objects">Creating New User Account Objects</h2> <p>Continuing the setup of our new active directory forest, we now need to add some user account objects to the domain. Go to ‘Tools’ → ‘Active Directory Users and Computers’. You should see the domain we just created. Clicking on it will reveal all of the organizational units (OUs) within that domain. At the bottom of the list we can see ‘Users’. Clicking on it reveals a lot of different security groups. Before we proceed further, we can clean the users up a bit.</p> <p><img src="/assets/images/homelab/activedir-vms-setup-pt2/ad-users+comps.jpg" alt="Active Directory Users and Computers" /></p> <p>Let’s right click our domain → ‘New’ → ‘Organizational Unit’. A new object creation window will pop up. Let’s name it ‘Groups’. After it’s created we can move all of the security groups from users to this OU. Now we have separated our users from our groups.</p> <p><img src="/assets/images/homelab/activedir-vms-setup-pt2/ad-newou.jpg" alt="Active Directory New OU Creation" /></p> <p>These are what the ‘Users’ and ‘Groups’ OUs should look like after the fact.</p> <p><img src="/assets/images/homelab/activedir-vms-setup-pt2/ad-groups.jpg" alt="Active Directory Groups OU" /></p> <p><img src="/assets/images/homelab/activedir-vms-setup-pt2/ad-users.jpg" alt="Active Directory Users OU" /></p> <p>Now we can add some new user objects. Let’s create a new domain admin account as well as a standard user account. Right click in the empty space of the ‘Users’ OU → ‘New’ → ‘User’. Name your users whichever you please. We want to keep our passwords the same across the board for this vulnerable active directory forest we are creating. Passwords are often reused in networks and password cracking/hash attacks will allow us to gain access to other accounts/machines through scripts like crackmapexec. Below are two user accounts that I’ve created.</p> <p><img src="/assets/images/homelab/activedir-vms-setup-pt2/ad-newuser.jpg" alt="Active Directory User 1 Creation" /></p> <p><img src="/assets/images/homelab/activedir-vms-setup-pt2/ad-userpass.jpg" alt="Active Directory User 1 Password" /></p> <p><img src="/assets/images/homelab/activedir-vms-setup-pt2/ad-userfinish.jpg" alt="Active Directory User 1 Finished" /></p> <p><img src="/assets/images/homelab/activedir-vms-setup-pt2/ad-newuser2.jpg" alt="Active Directory User 2 Creation" /></p> <p><img src="/assets/images/homelab/activedir-vms-setup-pt2/ad-userpass2.jpg" alt="Active Directory User 2 Password" /></p> <p><img src="/assets/images/homelab/activedir-vms-setup-pt2/ad-userfinish2.jpg" alt="Active Directory User 2 Finished" /></p> <p>Once our standard users are created, we will be creating a new administrative SQL Service account. Right click the admin account → ‘Copy’. Usually a SQL Service account would not be an administrator, but it is often something that a domain admin might accidentally overlook. By creating an admin SQL Service account, we can perform exploits such as Kerberoasting. For the password, we can change make this one different from the previous ones. Sse whatever weak password you want. I’m gonna use ‘Qwerty123!’. Make sure your new SQL Service administrative account looks the same as mine below.</p> <p><img src="/assets/images/homelab/activedir-vms-setup-pt2/ad-sqlservice.jpg" alt="Active Directory SQL Service Account Creation" /></p> <p><img src="assets/images/homelab/activedir-vms-setup-pt2/ad-sqlpassword.jpg" alt="Active Directory SQL Service Account Password" /></p> <p><img src="/assets/images/homelab/activedir-vms-setup-pt2/ad-sqlfinish.jpg" alt="Active Directory SQL Service Account Finish" /></p> <p>We will also be putting the password directly into the description of the account. Sometimes domain admins will make the mistake of thinking that only they are able to see the description of admin account objects, but this is not true. We can leverage this vulnerability in our exploits. Right click the SQL Service account → ‘Properties’. Add the password to the description and then click ‘Apply’.</p> <p><img src="/assets/images/homelab/activedir-vms-setup-pt2/ad-sqlproperties.jpg" alt="Active Directory SQL Service Account Properties" /></p> <p>We’re now done with adding all of the user objects we need for the time being. Your final view of the ‘Users’ OU should look like the image below.</p> <p><img src="/assets/images/homelab/activedir-vms-setup-pt2/ad-usersfinal.jpg" alt="Active Directory Users OU Finalized" /></p> <h2 id="setting-up-service-principal-name-for-sql-service">Setting Up Service Principal Name for SQL Service</h2> <p>Now that we have created the SQL Service account we need to create a corresponding SPN for it. Open up command prompt as administrator and type in the following command replacing the domain controller/domain name where appropriate.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>setspn -a 'YOUR-DC'/SQLService.YOURDOMAIN.local: 60111 YOURDOMAIN\SQLService
</code></pre></div></div><p><img src="/assets/images/homelab/activedir-vms-setup-pt2/ad-setspn.jpg" alt="Active Directory Setting SPN" /></p> <p>To check if the SPN was set correctly, type the following command replacing with your domain name when appropriate.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>setspn -T YOURDOMAIN.local -Q */*
</code></pre></div></div><p><img src="/assets/images/homelab/activedir-vms-setup-pt2/ad-spnfound.jpg" alt="Active Directory Checking SPN" /></p> <p>With this step now finished, our domain is now vulnerable to Kerberoasting attacks.</p> <h2 id="creating-an-smb-share-to-open-ports">Creating an SMB Share to Open Ports</h2> <p>Since SMB is a service that many attacks aim to exploit, we will need to open SMB ports 139/445. In the left-hand sidebar click ‘File and Storage Services’ → ‘Shares’ to get to the shares menu. Click on the ‘TASKS’ dropdown and then click ‘New Share’.</p> <p><img src="/assets/images/homelab/activedir-vms-setup-pt2/ad-newshare.jpg" alt="Active Directory Create New Share" /></p> <p>The New Share Wizard will be launched. Follow through the wizard using the below images as a guide.</p> <p><img src="/assets/images/homelab/activedir-vms-setup-pt2/smb-profile.jpg" alt="New Share Wizard Profile" /></p> <p><img src="/assets/images/homelab/activedir-vms-setup-pt2/smb-location.jpg" alt="New Share Wizard Location" /></p> <p><img src="/assets/images/homelab/activedir-vms-setup-pt2/smb-name.jpg" alt="New Share Wizard Name" /></p> <p><img src="/assets/images/homelab/activedir-vms-setup-pt2/smb-other.jpg" alt="New Share Wizard Other" /></p> <p><img src="/assets/images/homelab/activedir-vms-setup-pt2/smb-permissions.jpg" alt="New Share Wizard Permissions" /></p> <p><img src="/assets/images/homelab/activedir-vms-setup-pt2/smb-confirm.jpg" alt="New Share Wizard Confirmation" /></p> <p><img src="/assets/images/homelab/activedir-vms-setup-pt2/smb-results.jpg" alt="New Share Wizard Results" /></p> <p>Once that’s done, the shares page should now have our new share. SMB should now be open in the network, allowing us to make attacks on 139/445 against the DC and it’s clients. Speaking of clients, we now need to set those up as well.</p> <h2 id="windows-10-enterprise-installation">Windows 10 Enterprise Installation</h2> <p>We will be adding two Windows 10 Enterprise client machines to the forest.I will skip the OS installation as it is near identical to that of our server machine. Don’t forget to set the MAC address for each VM before launching for the first time. The specs for each machine are listed below. For the security questions, they don’t matter so put whatever you want.</p> <p><img src="/" alt="Windows 10 Client Machine 1 Specs" /></p> <p><img src="/" alt="Windows 10 Client Machine 2 Specs" /></p> <p>Once the OS is installed for both machines. Use the images below as a guide for finalizing the setup.</p> <p><img src="/assets/images/homelab/activedir-vms-setup-pt2/win10-region.jpg" alt="Windows 10 Setup Region" /></p> <p><img src="/assets/images/homelab/activedir-vms-setup-pt2/win10-keyboard.jpg" alt="Windows 10 Setup Keyboard" /></p> <p><img src="/assets/images/homelab/activedir-vms-setup-pt2/win10-account.jpg" alt="Windows 10 Setup Join Domain" /></p> <p><img src="/assets/images/homelab/activedir-vms-setup-pt2/win10-user.jpg" alt="Windows 10 Setup User" /></p> <p><img src="/assets/images/homelab/activedir-vms-setup-pt2/win10-pass.jpg" alt="Windows 10 Setup Password" /></p> <p><img src="/assets/images/homelab/activedir-vms-setup-pt2/win10-passconfirm.jpg" alt="Windows 10 Setup Confirm Password" /></p> <p><img src="/assets/images/homelab/activedir-vms-setup-pt2/win10-question1.jpg" alt="Windows 10 Setup Security Questions" /></p> <p><img src="/assets/images/homelab/activedir-vms-setup-pt2/win10-services.jpg" alt="Windows 10 Services" /></p> <h2 id="joining-the-clients-to-the-domain">Joining the Clients to the Domain</h2> <p>Before we join the clients to the domain, let’s first rename our machines. You can do this through the same process we used to rename our domain controller.</p> <p><img src="/assets/images/homelab/activedir-vms-setup-pt2/win10-renamepc.jpg" alt="Windows 10 Client Rename Device" /></p> <p>Once that’s complete, hold Win+R to open the Windows run command. Type in ‘ncpa.cpl’ to bring up the network connections. Right click ethernet0 → ‘Properties’ → ‘Internet Protocol Version 4 (TCP/IPv4)’ IP address of the domain controller (which should be 10.0.13.2 if you set it up correctly within pfSense) as the DNS gateway. We can also explicitly set our IP address and default gateway to our domain controller.</p> <p><img src="/assets/images/homelab/activedir-vms-setup-pt2/win10-ncpa.jpg" alt="Windows 10 Run Command" /></p> <p><img src="/assets/images/homelab/activedir-vms-setup-pt2/win10-connections.jpg" alt="Windows 10 Change IP/DNS Gateway" /></p> <p>Once this is done, we can restart the machine so that the PC name change takes effect. After the reboot, in the search bar enter ‘domain’ and choose ‘Access work or school’. Click ‘Connect’ → ‘Join this device to a local Active Directory domain’. When prompted, enter the name of your domain. In the next step, enter the credentials for the domain admin account. Finally, choose the skip option on the last screen. Afterwards the device will need a restart.</p> <p><img src="/assets/images/homelab/activedir-vms-setup-pt2/win10-workschool.jpg" alt="Windows 10 Work and School" /></p> <p><img src="/assets/images/homelab/activedir-vms-setup-pt2/win10-joindomain.jpg" alt="Windows 10 Join Domain Connect" /></p> <p><img src="/assets/images/homelab/activedir-vms-setup-pt2/win10-joindomain2.jpg" alt="Windows 10 Join Domain Enter Domain Name" /></p> <p><img src="/assets/images/homelab/activedir-vms-setup-pt2/win10-joindomain3.jpg" alt="Windows 10 Join Domain Admin Credentials" /></p> <p><img src="/assets/images/homelab/activedir-vms-setup-pt2/win10-joindomain4.jpg" alt="Windows 10 Join Domain Skip" /></p> <p>If we go back to our domain controller, we should now see the device itself as a new object within the ‘Computers’ OU. If that’s the case then you’ve successfully added the first client to the domain. Go ahead and repeat all of the above steps in this section for the second client machine.</p> <p><img src="/assets/images/homelab/activedir-vms-setup-pt2/ad-pcadded.jpg" alt="AD Updated Computers OU" /></p> <h2 id="creating-local-administrators-for-the-client-machines">Creating Local Administrators for the Client Machines</h2> <p>It’s a common thing in active directory networks to setup domain users as local administrators on the device that they use. We are going to do this so that we are able to perform more attacks and escalate privileges. First, we need to log into the client machine as the domain admin account. To do this on the login page click other and then type in ‘DOMAINNAME\Administrator’. Of course, replace DOMAINNAME with your own domain’s name.</p> <p><img src="/assets/images/homelab/activedir-vms-setup-pt2/win10-otheruser.jpg" alt="Windows 10 Login Other User" /></p> <p>Once in, type ‘computer management’ into the search bar and select that option. In the computer management window, click ‘Local Computers and Groups’ → ‘Groups’ → ‘Administrators. Here we are going to add our user account as a local admin. Once that’s done, we are also going to add the other domain user account that we created as a local admin on this machine as well. This way we cna make our domain vulnerable to relay attacks. Repeat the below steps for the second client machine as well.</p> <p><img src="/assets/images/homelab/activedir-vms-setup-pt2/win10-management.jpg" alt="Windows 10 Search Computer Management" /></p> <p><img src="/assets/images/homelab/activedir-vms-setup-pt2/win10-management2.jpg" alt="Windows 10 Search Computer Management" /></p> <p><img src="/assets/images/homelab/activedir-vms-setup-pt2/win10-management3.jpg" alt="Windows 10 Search Computer Management" /></p> <p><img src="/assets/images/homelab/activedir-vms-setup-pt2/win10-management4.jpg" alt="Windows 10 Search Computer Management" /></p> <p>With that, our full active directory forest is setup. Following all of the steps so far our lab should be equipped for performing several attacks such as LLMNR/NBT-NS poisoning, SMB Relay Attacks, Pass-the-Password, Pass-the-Hash, Token Impersonation, Kerberoasting, Golden Ticket, enumeration with Powerview/Bloodhound, credential dumping, and more.</p> <table> <tbody> <tr> <td>We will be setting up Wazuh to ingest Suricata logs from pfSense soon. You can find the next part, ‘VMWare Pro Homelab</td> <td>Active Directory Forest Setup Pt. 2’, in the [blog] section of this site.</td> </tr> </tbody> </table> </article></div><hr class="dashed" /><div class="container"><div class="row"><div class="col-md-12"> <p class="categories" data-aos="fade-up"> <span ><a href="/categories/#blog" >Blog</a ></span > </p></div></div><div class="recent" data-aos="fade-up"><div class=""> <h3>Recent Articles</h3></div><div class="recent-grid"><div class="items" data-aos="fade-up"> <a class="nostyle item" href="/blog/homelab-wazuh/"><div class="cards"><div class="image rounded" style="background-image: url(/assets/images/thumbnails/homelab/Homelab-setup-guide-wazuh.jpg)" ></div><p class="title"><small>VMWare Pro Homelab | Monitoring Suricata/Windows Logs With Wazuh</small></p></div></a></div><div class="items" data-aos="fade-up"> <a class="nostyle item" href="/blog/homelab-suricata/"><div class="cards"><div class="image rounded" style="background-image: url(/assets/images/thumbnails/homelab/Homelab-setup-guide-suricata.jpg)" ></div><p class="title"><small>VMWare Pro Homelab | Suricata Setup on pfSense with Snort Alerts</small></p></div></a></div><div class="items" data-aos="fade-up"> <a class="nostyle item" href="/blog/homelab-ad-forest/"><div class="cards"><div class="image rounded" style="background-image: url(/assets/images/thumbnails/homelab/Homelab-setup-guide-windows.jpg)" ></div><p class="title"><small>VMWare Pro Homelab | Active Directory Forest Setup pt. 1</small></p></div></a></div><div class="items" data-aos="fade-up"> <a class="nostyle item" href="/blog/homelab-dvwa/"><div class="cards"><div class="image rounded" style="background-image: url(/assets/images/thumbnails/homelab/Homelab-setup-guide-dvwa.jpg)" ></div><p class="title"><small>VMWare Pro Homelab | DVWA Setup on Ubuntu Server</small></p></div></a></div></div></div></div></main><div id="search-container"></div><hr class="dashed" /><footer data-aos="fade-up"><div class="text-right"> <p class="copy"> <i class="fa fa-at"></i> 2018 <a class="rev" href="/">Blackcurrant</a> </p></div></footer></div></div></div></div><script src="/assets/js/jQuery.min.js"></script><script> $(document).ready(function () { $(".loader").hide(); });</script><script> (function () { var css = document.createElement("link"); css.href = "/assets/font-awesome-4.7.0/css/font-awesome.min.css"; css.rel = "stylesheet"; css.type = "text/css"; document.getElementsByTagName("head")[0].appendChild(css); })();</script><noscript><link rel="stylesheet" href="/assets/font-awesome-4.7.0/css/font-awesome.min.css" /> </noscript><script> $("#search-input").keyup(function () { $("main").hide(); $("search-container").show(); if (!$("#search-input").val()) { $("main").show(); $("search-container").hide(); } });</script><script src="/assets/js/jekyll-search.min.js"></script><script> SimpleJekyllSearch({ searchInput: document.getElementById("search-input"), resultsContainer: document.getElementById("search-container"), searchResultTemplate: '<a class="nostyle" href="{url}"><div class="blog borders cards"><div class="image" style="background-image: url({image});"></div><div class="content"><h3 class="title">{title}</h3><p class="description">{description}</p></div></div></a>', noResultsText: "No results found", json: "/search.json", });</script><script> (function () { var css = document.createElement("link"); css.href = "https://unpkg.com/aos@2.3.1/dist/aos.css"; css.rel = "stylesheet"; css.type = "text/css"; document.getElementsByTagName("head")[0].appendChild(css); })();</script><noscript><link rel="stylesheet" href="/assets/animate-on-scroll/aos.min.css" /> </noscript><script src="/assets/animate-on-scroll/aos.min.js"></script><script> AOS.init({ duration: 600, once: true, disable: "mobile", });</script></body></html>