<!-- This layout is used in all pages. Making changes here will efect all pages. We recommend not to change anything here. --> <!DOCTYPE html><html lang="en"><head><meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" /><link rel="dns-prefetch" href="//fonts.googleapis.com" /><link rel="dns-prefetch" href="//google-analytics.com" /><link rel="dns-prefetch" href="//www.google-analytics.com" /><link rel="dns-prefetch" href="//maxcdn.bootstrapcdn.com" /><link rel="dns-prefetch" href="//ajax.googleapis.com" /><link rel="dns-prefetch" href="//fonts.gstatic.com" /><link rel="dns-prefetch" href="https://.disqus.com/" /><title>VMWare Pro Homelab Monitoring Suricata/Windows Logs With Wazuh | My Portfolio</title><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="VMWare Pro Homelab Monitoring Suricata/Windows Logs With Wazuh" /><meta name="author" content="Ethan Epperson" /><meta property="og:locale" content="en_US" /><meta name="description" content="Enabling use of FreeBSD repos on pfSense" /><meta property="og:description" content="Enabling use of FreeBSD repos on pfSense" /><link rel="canonical" href="http://localhost:4000/blog/homelab-wazuh/" /><meta property="og:url" content="http://localhost:4000/blog/homelab-wazuh/" /><meta property="og:site_name" content="My Portfolio" /><meta property="og:image" content="http://localhost:4000/assets/images/thumbnails/homelab/Homelab-setup-guide-wazuh.jpg" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-01-18T00:00:00-05:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="http://localhost:4000/assets/images/thumbnails/homelab/Homelab-setup-guide-wazuh.jpg" /><meta property="twitter:title" content="VMWare Pro Homelab Monitoring Suricata/Windows Logs With Wazuh" /><script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Ethan Epperson"},"dateModified":"2024-01-18T00:00:00-05:00","datePublished":"2024-01-18T00:00:00-05:00","description":"Enabling use of FreeBSD repos on pfSense","headline":"VMWare Pro Homelab Monitoring Suricata/Windows Logs With Wazuh","image":"http://localhost:4000/assets/images/thumbnails/homelab/Homelab-setup-guide-wazuh.jpg","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/blog/homelab-wazuh/"},"url":"http://localhost:4000/blog/homelab-wazuh/"}</script><link rel="stylesheet" href="/assets/css/main-default.css" /><link id="color-scheme" rel="stylesheet" href="/assets/css/main-default.css" /><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/apple-icon-60x60.png" /><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/apple-icon-114x114.png" /><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/apple-icon-152x152.png" /><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/android-icon-192x192.png" /><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" /><link rel="icon" href="/favicon.ico" type="image/x-icon" /><script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML" ></script><script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script></head><body><div class="loader"><div class="lds-ring"><div></div><div></div><div></div><div></div></div></div><div class="wrapper"><div class="container-grid"><div class="sidebar"><div class="author-container shadow"><div class="author"> <a href="/"> <img src="/assets/images/headshots/professional-hs.jpg" width="100%" height="auto;" alt="My Portfolio"loading="lazy" /> </a></div><div class="about text-center"><h1 class="title"><a href="/">Ethan Epperson</a></h1></div><div class="bio text-center"><p class="m0">Cybersecurity Student | Let's Defend Together</p></div><hr class="dashed"><div class="social text-center"> <ul class="portfolio p0"> <li><a href="/projects/">Projects</a></li> <li><a href="/blog/">Blog</a></li> <li><a href="/contact/">Contact</a></li> </ul> <ul class="sm p0 m0a"> <li><a href="https://www.linkedin.com/in/ethan-epperson-8608b5277"><i class="fa fa-linkedin"></i></a></li> <li><a href="https://www.github.com/EEpp14"><i class="fa fa-github"></i></a></li> </ul></div></div></div><div class="main"><div class="main-container shadow"><div class="title-space"> <h1>VMWare Pro Homelab | Monitoring Suricata/Windows Logs With Wazuh</h1><div class="input-group mb-3" data-aos="zoom-in"> <input type="text" class="form-control border-right-0" id="search-input" /><div class="input-group-append"> <span class="input-group-text" ><i class="fa fa-search"></i ></span></div></div></div><hr class="dashed" /> <main> <ul class="breadcrumbs"> <li><a href="/">Home</a></li> <li> <a href="/blog" >Blog</a > </li> <li> <a href="#" >Homelab wazuh</a > </li> </ul><div class="meta" data-aos="fade-up"> <p> <small> <span> <i class="fa fa-calendar" aria-hidden="true"></i> 18 Jan 2024&nbsp; </span> <span> <i class="fa fa-user" aria-hidden="true"></i> Ethan Epperson&nbsp; </span> <span> <i class="fa fa-clock-o" aria-hidden="true"></i> 5 mins read. </span> </small> </p></div><div class="featured-image rounded shadow" style="background-image: url(/assets/images/thumbnails/homelab/Homelab-setup-guide-wazuh.jpg)" data-aos="zoom-in" ></div><div class="container"> <article> <ul class="toc"> <li><a href="#enabling-use-of-freebsd-repos-on-pfsense">Enabling use of FreeBSD repos on pfSense</a></li> <li><a href="#installing-the-wazuh-agent-for-pfsense">Installing the Wazuh Agent for pfSense</a></li> <li><a href="#configuration-and-enabling-the-agent">Configuration and Enabling the Agent</a></li> <li><a href="#accessing-wazuh-dashboard--ingesting-suricata-logs">Accessing Wazuh Dashboard &amp; Ingesting Suricata Logs</a></li> </ul> <h2 id="enabling-use-of-freebsd-repos-on-pfsense">Enabling use of FreeBSD repos on pfSense</h2> <p>This section will cover how to enable the Wazuh SIEM solution to ingest Suricata logs from pfSense. In order to do this we must first lay some groundwork. Wazuh packages are not part of the official pfSense reposititories, so we are going to need to install our Wazuh agent via the use of the official FreeBSD repos. In pfsense launch a prompt by typing in ‘8’ and hitting enter. By default, FreeBSD repositories are not enabled, so we will need to change that in some config files using the vi editor. If you don’t know how to use vi there are plenty of helpful guides out there. Enter the following commands to alter the config files:</p><pre><code class="language-unix">cd ..
vi /usr/local/etc/pkg/repos/FreeBSD.conf
vi /usr/local/etc/pkg/repos/pfSense.conf
</code></pre><p>We need to change the following lines as below in both files. When you are done type :wq to write and quit out of vi.</p><pre><code class="language-unix">FreeBSD: { enabled: no  }
</code></pre><p>TO</p><pre><code class="language-unix">FreeBSD: { enabled: yes  }
</code></pre><h2 id="installing-the-wazuh-agent-for-pfsense">Installing the Wazuh Agent for pfSense</h2> <p>Now that we have changed the configs, we can go about installing the wazuh agent from the FreeBSD package repository. In order to do this we need to run the following commands:</p><pre><code class="language-unix"># we need to update the package cache first, you might get a warning about a mismatch, ignore this and enter 'y' to continue

pkg update

# this searches for the official wazuh agent

pkg search wazuh-agent

# replace the x.x.xx with the version of wazuh you have installed on your server or ova installation

pkg install wazuh-agent-x.x.xx
</code></pre><p>Once the installation process is done, we will need to revert the config files back to how they were before.</p><pre><code class="language-unix">FreeBSD: { enabled: yes  }
</code></pre><p>TO</p><pre><code class="language-unix">FreeBSD: { enabled: no  }
</code></pre><p><img src="/assets/images/homelab/wazuh-setup/pfsense-freebsd.jpg" alt="pfSense vi FreeBSD" /></p> <p>Once you’ve reverted them back to base, run these two commands as well</p><pre><code class="language-unix">pkg clean
pkg update
</code></pre><h2 id="configuration-and-enabling-the-agent">Configuration and Enabling the Agent</h2> <p>The installation is now finalized! In the output after the installation we were given these suggestions, so let’s go ahead and do that in order.</p><pre><code class="language-unix">--
Wazuh Agent was installed

1) Copy /etc/locatime to /var/ossec/etc directory

   # cp /etc/localtime /var/ossec/etc

2) You must edit /var/ossec/etc/ossec.conf.sample for your setup and rename/copy
   it to ossec.conf

   Take a look wazuh configuration at the following url:

   https://documentation.wazuh.com/current/user-manual/index.html

3) You can find additional useful files installed at

  # /var/ossec/packages_files/agent_installation_scripts

4) Add Wazuh agent to /etc/rc.conf

  # sysrc wazuh_agent_enable="YES"

5) Start Wazuh agent

  # service wazuh_agent start

6) Enjoy it ;)
</code></pre><p>First, it recommends we copy the /etc/localtime to /var/ossec/etc, we can do that with the command it gave us above. Once that’s done we need to edit the config file. It says we need to rename the sample, yet it already created a config file for us, so we can ignore this step. Vi into the file and change the IP address to that of the server where the manager is stored. For us, that should be 10.0.11.3. Write and quit out of vi.</p> <p><img src="/assets/images/homelab/wazuh-setup/pfsense-wazuhip.jpg" alt="Setting Wazuh Manager IP Address" /></p> <p>We’ve already done the groundwork for each of our interfaces by enabling JSON output to the syslog of pfSense, so now let’s start the agent. Run the following commands:</p><pre><code class="language-unix">sysrc wazuh_agent_enable="YES"
service wazuh-agent start
</code></pre><p>You would need to do this every time you boot up pfSense, but if you wanted to automate the commands you could create a shell script that automates the process. Place them in the /usr/local/etc/rc.d directory. It might look something like the image below.</p> <p><img src="/assets/images/homelab/wazuh-setup/pfsense-script1.jpg" alt="Wazuh Agent Automation Script" /></p> <h2 id="accessing-wazuh-dashboard--ingesting-suricata-logs">Accessing Wazuh Dashboard &amp; Ingesting Suricata Logs</h2> <p>We can now head over to the Wazuh dashboard at 10.0.11.3 from our Kali machine. Our dashboard should now be populated with one active agent, and if we click on it we can see that it’s our pfSense agent.</p> <p><img src="/assets/images/homelab/wazuh-setup/wazuh-dash.jpg" alt="Wazuh Dashboard" /></p> <p><img src="/assets/images/homelab/wazuh-setup/wazuh-active.jpg" alt="Wazuh pfSense Agent" /></p> <p>Now we can actually begin to have Suricata logs ingested into Wazuh. On the homepage click the dropdown arrow and under to ‘Management’ click ‘Groups’. Click on ‘Add New Group’ and name it ‘pfSense’. Then click the pencil icon to edit the group configuration settings. You will be presented with the empty agent.conf file of the pfSense group. We need to add the following lines:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;localfile&gt;
    &lt;log_format&gt;json&lt;/log_format&gt;
    &lt;location&gt;/var/log/suricata/*/eve.json&lt;/location&gt;
&lt;/localfile&gt;
</code></pre></div></div><p><img src="/assets/images/homelab/wazuh-setup/wazuh-agentconfig.jpg" alt="Wazuh pfSense Agent Config" /></p> <p>Click on the group we just created and then click ‘Manage Agents’. Select the pfSense agent and add it to the group. We can also go ahead and remove pfSense from the default group.</p> <p><img src="/assets/images/homelab/wazuh-setup/wazuh-manageagents.jpg" alt="Wazuh pfSense Security Events" /></p> <p><img src="/assets/images/homelab/wazuh-setup/wazuh-addtogroup.jpg" alt="Wazuh pfSense Security Events" /></p> <p>After this is complete, assuming Suricata is currently active on our interfaces in pfSense, we should now be getting logs from Suricata in our Wazuh dashboard! If we click on our agent within the dashboard, we can now view security events based on the logs we receive from Suricata. I went ahead and did some nmap scans from my Kali machine towards the Vulnhub VM, so it’s already a bit populated.</p> <p><img src="/assets/images/homelab/wazuh-setup/wazuh-events.jpg" alt="Wazuh pfSense Security Events" /></p> <p>This brings us to the very end of the homelab build. Congrats on making it to the end and good luck on your security journey!</p> </article></div><hr class="dashed" /><div class="container"><div class="row"><div class="col-md-12"> <p class="categories" data-aos="fade-up"> <span ><a href="/categories/#blog" >Blog</a ></span > </p></div></div><div class="recent" data-aos="fade-up"><div class=""> <h3>Recent Articles</h3></div><div class="recent-grid"><div class="items" data-aos="fade-up"> <a class="nostyle item" href="/blog/homelab-suricata/"><div class="cards"><div class="image rounded" style="background-image: url(/assets/images/thumbnails/homelab/Homelab-setup-guide-suricata.jpg)" ></div><p class="title"><small>VMWare Pro Homelab | Suricata Setup on pfSense with Snort Alerts</small></p></div></a></div><div class="items" data-aos="fade-up"> <a class="nostyle item" href="/blog/homelab-ad-forest-pt.2/"><div class="cards"><div class="image rounded" style="background-image: url(/assets/images/thumbnails/homelab/Homelab-setup-guide-windows.jpg)" ></div><p class="title"><small>VMWare Pro Homelab | Active Directory Forest Setup pt. 2</small></p></div></a></div><div class="items" data-aos="fade-up"> <a class="nostyle item" href="/blog/homelab-ad-forest/"><div class="cards"><div class="image rounded" style="background-image: url(/assets/images/thumbnails/homelab/Homelab-setup-guide-windows.jpg)" ></div><p class="title"><small>VMWare Pro Homelab | Active Directory Forest Setup pt. 1</small></p></div></a></div><div class="items" data-aos="fade-up"> <a class="nostyle item" href="/blog/homelab-dvwa/"><div class="cards"><div class="image rounded" style="background-image: url(/assets/images/thumbnails/homelab/Homelab-setup-guide-dvwa.jpg)" ></div><p class="title"><small>VMWare Pro Homelab | DVWA Setup on Ubuntu Server</small></p></div></a></div></div></div></div></main><div id="search-container"></div><hr class="dashed" /><footer data-aos="fade-up"><div class="text-right"> <p class="copy"> <i class="fa fa-at"></i> 2018 <a class="rev" href="/">Blackcurrant</a> </p></div></footer></div></div></div></div><script src="/assets/js/jQuery.min.js"></script><script> $(document).ready(function () { $(".loader").hide(); });</script><script> (function () { var css = document.createElement("link"); css.href = "/assets/font-awesome-4.7.0/css/font-awesome.min.css"; css.rel = "stylesheet"; css.type = "text/css"; document.getElementsByTagName("head")[0].appendChild(css); })();</script><noscript><link rel="stylesheet" href="/assets/font-awesome-4.7.0/css/font-awesome.min.css" /> </noscript><script> $("#search-input").keyup(function () { $("main").hide(); $("search-container").show(); if (!$("#search-input").val()) { $("main").show(); $("search-container").hide(); } });</script><script src="/assets/js/jekyll-search.min.js"></script><script> SimpleJekyllSearch({ searchInput: document.getElementById("search-input"), resultsContainer: document.getElementById("search-container"), searchResultTemplate: '<a class="nostyle" href="{url}"><div class="blog borders cards"><div class="image" style="background-image: url({image});"></div><div class="content"><h3 class="title">{title}</h3><p class="description">{description}</p></div></div></a>', noResultsText: "No results found", json: "/search.json", });</script><script> (function () { var css = document.createElement("link"); css.href = "https://unpkg.com/aos@2.3.1/dist/aos.css"; css.rel = "stylesheet"; css.type = "text/css"; document.getElementsByTagName("head")[0].appendChild(css); })();</script><noscript><link rel="stylesheet" href="/assets/animate-on-scroll/aos.min.css" /> </noscript><script src="/assets/animate-on-scroll/aos.min.js"></script><script> AOS.init({ duration: 600, once: true, disable: "mobile", });</script></body></html>